\doxysection{D\+:/\+Projects/\+Raspberrypi\+\_\+pico/pico\+\_\+freertos\+\_\+final/freertos\+\_\+pico2/pico\+\_\+freertos/\+Free\+RTOS-\/\+Kernel/portable/\+Third\+Party/\+GCC/\+ATmega Directory Reference}
\hypertarget{dir_e07bac294b692bb2c641596d15e2d600}{}\label{dir_e07bac294b692bb2c641596d15e2d600}\index{D:/Projects/Raspberrypi\_pico/pico\_freertos\_final/freertos\_pico2/pico\_freertos/FreeRTOS-\/Kernel/portable/ThirdParty/GCC/ATmega Directory Reference@{D:/Projects/Raspberrypi\_pico/pico\_freertos\_final/freertos\_pico2/pico\_freertos/FreeRTOS-\/Kernel/portable/ThirdParty/GCC/ATmega Directory Reference}}
Directory dependency graph for ATmega\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=164pt]{dir_e07bac294b692bb2c641596d15e2d600_dep}
\end{center}
\end{figure}
\doxysubsubsection*{Files}
\begin{DoxyCompactItemize}
\item 
file \mbox{\hyperlink{_third_party_2_g_c_c_2_a_tmega_2port_8c}{port.\+c}}
\item 
file \mbox{\hyperlink{_third_party_2_g_c_c_2_a_tmega_2portmacro_8h}{portmacro.\+h}}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
\doxysubsubsection*{ATmegaxxxx}

{\bfseries{Port for generalised Microchip ATmega architecture}}

\doxysubsubsubsection*{Description}

This port provides a basis for supporting all modern ATmega devices using either the Enhanced Watchdog Timer, or Timer0 (an 8-\/bit Timer generally available across the whole range).

This initial commit contains the information required to build with System Tick being generated by either the\+:
\begin{DoxyItemize}
\item Watchdog Timer, or
\item Timer0 -\/ an 8-\/bit Timer, or
\item TimerN -\/ a 16-\/bit Timer which will be configured by the user.
\end{DoxyItemize}

Further commits can add support for 16-\/bit Timers available on many relevant devices. The availability of these 16-\/bit Timers is somewhat device specific, and these complex and highly configurable Timers are often used to generate phase correct PWM timing (for example) and they would be wasted as a simple System Tick.

The port also provides support for the 3 byte program counter devices {\bfseries{ATmega2560}} and {\bfseries{ATmega2561}}. Specific to these two devices the {\ttfamily EIND} register need to be preserved during a context switch. Also, due to a limitation in GCC, the scheduler needs to reside in the lower 128kB of flash for both of these devices. This is achieved by adding the {\ttfamily .lowtext} section attribute to the function prototype.

To build generic Microchip (AVR) ATmega support the similarities across the family must be considered, and differences respected. Some comments on the strategy follow.

\doxysubsubsubsection*{System Tick}

The Microchip (AVR) ATmega family has limited Timer and Pin capabilities, and is designed to be used in physical applications, controlling hardware with PWM and recognising level and edge voltage changes. It does this mainly through the use of 16-\/bit Timers (for generating phase correct PWM by up/down counting), and Pins attached to Interrupts. The 8-\/bit Timers are also attached to Pins, and they can be used for more simple timing tasks, requiring only a single counting direction.

The Timers not attached to Pins (and therefore not impacting the application of the device) are some 16-\/bit Timers (very device dependent, eg Timer3 on 1284p), The RTC Timer, and the Watch Dog Timer.

The Watch Dog Timer is configured identically across most of the ATmega devices. It comes in two variants. 1. Old style (eg ATmega32) which does not have an Interrupt capability, and hence on these old devices cannot be used as the System Tick. and 2. New style enhanced WDT, which can generate an Interrupt, and is available on every relevant device.

Using the Watch Dog Timer (WDT) to generate the System Tick does not impact its use as a watch dog. It can be configured to generate a System Tick interrupt, and then one period later to Reset the device if the interrupt is not serviced.

Configuration and usage of the WDT is covered in {\ttfamily \texorpdfstring{$<$}{<}avr/wdt.\+h\texorpdfstring{$>$}{>}} which was revised in avr-\/libc 2.\+0.\+0.

Two additional WDT functions are provided in {\ttfamily port.\+c}, which extend avr-\/libc functions to enable the WDT Interrupt without enabling Reset {\ttfamily wdt\+\_\+interrupt\+\_\+enable()}, and to enable both the Interrupt and the Reset {\ttfamily wdt\+\_\+interrupt\+\_\+reset\+\_\+enable()}.

\doxysubsubsubsection*{3 Byte PC Devices}

The ATtiny, ATmega, ATxmega families can optionally support both 3 byte PC and 3 byte RAM addresses. However, focusing on just the ATmega family only two devices have a large Flash requiring them to use 3 byte PC. These are the {\bfseries{ATmega2560}} and {\bfseries{ATmega2561}}. This PR provides support for these two devices in two ways.


\begin{DoxyItemize}
\item providing {\ttfamily \doxylink{_code_warrior_2_cold_fire___v2_2port_8c_a798f37b250502b49763c54a56b3aa4b0}{port\+SAVE\+\_\+\+CONTEXT()}} and {\ttfamily port\+RESTORE\+\_\+\+CONTEXT} saving both the {\bfseries{RAMPZ}} and {\bfseries{EIND}} registers.
\item providing a {\ttfamily \doxylink{_a_r_mv8_m_2non__secure_2portmacrocommon_8h_a2921e1c5a1f974dfa01ae44d1f665f14}{port\+TASK\+\_\+\+FUNCTION\+\_\+\+PROTO()}} with the linker attribute {\ttfamily .lowtext} which is used to ensure that the scheduler and relevant functions remain in the lower 128kB of Flash.
\end{DoxyItemize}

For devices which can support {\bfseries{XRAM}} and have the {\bfseries{RAMPZ}} register, this register is also preserved during the context switch.

\doxysubsubsubsection*{Interrupt Nesting}

The ATmega family does not support interrupt nesting, having only one interrupt priority. This means that when the Scheduler is running, interrupts are normally disabled.

When a very time critical process is running, based on microsecond timing generated by one of the Timers, it is important to re-\/enable interrupts as early as possible in processing a Yield. Fortunately, this is supported through the use of the {\ttfamily NO\+\_\+\+BLOCK} decorator when defining the Interrupt Service Routine.

The {\ttfamily NO\+\_\+\+BLOCK} decorator will enable the global interrupt early in the handling of an ISR (in this case for the Scheduler), and enable interrupts to be nested. Using this method, I\textquotesingle{}ve been able to successfully implement an \href{https://feilipu.me/2015/06/02/goldilocks-analogue-synthesizer/}{\texttt{Audio Synthesiser}} with less than 83 microseconds for each cycle, whilst still running the Scheduler to handle display and input.

Using {\ttfamily NO\+\_\+\+BLOCK} is optional, and should only be done if a critical Timer should interrupt the Scheduler.

\doxysubsubsubsection*{Heap Management}

Most users of Free\+RTOS will choose to manage their own heap using one of the pre-\/allocated heap management algorithms, but for those that choose to use {\ttfamily \doxylink{heap__3_8c}{heap\+\_\+3.\+c}}, the wrappered {\ttfamily malloc()} method, there is an issue that needs to be addressed.

The avr-\/libc library assumes that the stack will always be above the heap, and does a check for this when responding to a {\ttfamily malloc()} request. This is not the case when Tasks are running, as their stack is located in the early allocated heap address ranges which will be below free heap memory, and so the {\ttfamily malloc()} request will fail even though heap space is available.

To avoid this issue causing {\ttfamily pv\+Port\+\_\+\+Malloc()} to failing, the user needs to issue this tuning statement BEFORE they use the heap, or use the {\ttfamily x\+Task\+Create()} API.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordflow}{if}(\ \_\_malloc\_heap\_end\ ==\ 0\ )}
\DoxyCodeLine{\ \ \ \ \_\_malloc\_heap\_end\ =\ (\textcolor{keywordtype}{char}\ *)(RAMEND\ -\/\ \_\_malloc\_margin);}

\end{DoxyCode}
 Unfortunately in the repository there is nowhere sensible to include this statement as it should be included early in the {\ttfamily \doxylink{main_8c_a840291bc02cba5474a4cb46a9b9566fe}{main()}} function.

For devices which can support {\bfseries{XRAM}} the user will need to tune the location of stack and heap according to their own requirements.

\doxysubsubsubsection*{Supported Devices}

ATmega devices with {\bfseries{ENHANCED WDT}} Interrupt capability -\/ will use WDT.


\begin{DoxyItemize}
\item ATmega8\+U2/16\+U2/32\+U2 -\/\texorpdfstring{$>$}{>} 2kB RAM
\item ATmega16\+U4/32\+U4 -\/ Arduino Leonardo -\/\texorpdfstring{$>$}{>} 2.\+5kB RAM
\item ATmega48\+PB/88\+PB/168\+PB/328\+PB -\/ Arduino Uno -\/\texorpdfstring{$>$}{>} 2kB RAM
\item ATmega164\+PA/324\+PA/644\+PA/1284P -\/ Goldilocks -\/\texorpdfstring{$>$}{>} {\bfseries{16kB RAM}}
\item ATmega324\+PB -\/\texorpdfstring{$>$}{>} 2kB RAM
\item ATmega640/1280/2560/1281/2561 -\/ Arduino Mega -\/\texorpdfstring{$>$}{>} {\bfseries{8kB RAM + XRAM}}
\end{DoxyItemize}

ATmega devices without enhanced {\bfseries{WDT}} Interrupt capability -\/ will use a 8-\/bit or 16-\/bit Timer.


\begin{DoxyItemize}
\item ATmega8\+A/16\+A/32\+A/64\+A/128A -\/\texorpdfstring{$>$}{>} 4kB RAM
\item ATmega165\+A/165\+PA/325\+A/325\+PA/3250\+A/3250\+PA/645\+A/645\+P/6450\+A/6450P -\/\texorpdfstring{$>$}{>} 4kB RAM
\item ATmega169\+A/169\+PA/329\+A/329\+PA/3290\+A/3290\+PA/649\+A/649\+P/6490\+A/6490P -\/\texorpdfstring{$>$}{>} 4kB RAM
\item ATmega808/809/1608/1609/3208/3209/4808/4809 -\/ mega\+AVR 0-\/Series -\/\texorpdfstring{$>$}{>} 6kB RAM 
\end{DoxyItemize}